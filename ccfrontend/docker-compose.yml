version: '3.8'

services:
  # Frontend Application
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cuentas-claras-frontend
    ports:
      - '${FRONTEND_PORT:-5173}:5173'
    environment:
      - NODE_ENV=production
      - API_BASE_URL=${API_BASE_URL:-http://backend:8000}
      - NEXT_PUBLIC_APP_NAME=Cuentas Claras
      - NEXT_PUBLIC_ENVIRONMENT=production
      - NEXT_PUBLIC_DEBUG_MODE=false
      - NEXT_PUBLIC_LOG_LEVEL=error
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - cuentas-claras-network
    restart: unless-stopped
    volumes:
      - ./logs/frontend:/app/logs
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5173']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    labels:
      - "com.example.description=Cuentas Claras Frontend"

  # Backend API
  backend:
    image: ${BACKEND_IMAGE:-cuentas-claras-backend:latest}
    container_name: cuentas-claras-backend
    ports:
      - '${BACKEND_PORT:-8000}:8000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://${DB_USER:-user}:${DB_PASSWORD:-password}@db:5432/${DB_NAME:-cuentas_claras}
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cuentas-claras-network
    restart: unless-stopped
    volumes:
      - ./logs/backend:/app/logs
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    labels:
      - "com.example.description=Cuentas Claras Backend API"

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: cuentas-claras-db
    environment:
      - POSTGRES_DB=${DB_NAME:-cuentas_claras}
      - POSTGRES_USER=${DB_USER:-user}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-password}
      - POSTGRES_INITDB_ARGS=-c shared_preload_libraries=pg_stat_statements
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    networks:
      - cuentas-claras-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USER:-user}']
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - 'postgres'
      - '-c'
      - 'max_connections=100'
      - '-c'
      - 'shared_buffers=256MB'
    labels:
      - "com.example.description=PostgreSQL Database"

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: cuentas-claras-redis
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis_data:/data
    networks:
      - cuentas-claras-network
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_password}
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 3
    labels:
      - "com.example.description=Redis Cache"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  cuentas-claras-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

